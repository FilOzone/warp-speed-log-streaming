# Curio PDP - Better Stack Log Streaming Configuration
# Source: https://github.com/FilOzone/warp-speed-log-streaming/blob/main/vector.yaml
# Auto-configured by warp-speed-log-streaming installer

sources:
  curio_logs:
    type: "file"
    read_from: "end"
    include: ["/var/log/curio/curio.log"]

  curio_version_heartbeat:
    type: "exec"
    mode: "scheduled"
    command: ["sh", "-c", "curio --version 2>/dev/null"]
    scheduled:
      exec_interval_secs: 300  # Every 5 minutes

transforms:
  curio_parser:
    type: "remap"
    inputs: ["curio_logs"]
    source: |
      .client_id = "YOUR_CLIENT_ID"
      .platform = "Curio PDP"

      # Remove fields that reveal unneeded SP info.
      del(.source_type)
      del(.host)
      del(.file)

      # Parse JSON from message field and inline it
      parsed, err = parse_json(.message)
      if err == null {
        . = merge!(., parsed)
        # Remove original message field since the fields have been inlined
        del(.message)
      }

      # Set dt, which is required for BetterStack.
      # Priority is given to .ts over .timestamp.
      # They are then removed to avoid duplication/clutter.
      if exists(.timestamp) {
        .dt = del(.timestamp)
      }
      if exists(.ts) {
        .dt = del(.ts)
      }

  version_parser:
    type: "remap"
    inputs: ["curio_version_heartbeat"]
    source: |
      .client_id = "YOUR_CLIENT_ID"
      .platform = "Curio PDP"
      .curio_version = string!(.message)
      .dt = now()
      del(.host)
      del(.source_type)

sinks:
  better_stack_logs:
    type: "http"
    method: "post"
    uri: "https://s1560290.eu-nbg-2.betterstackdata.com/"
    encoding:
      codec: "json"
    compression: "gzip"
    auth:
      strategy: "bearer"
      token: "YOUR_BETTER_STACK_TOKEN"
    inputs: ["curio_parser", "version_parser"]
    batch:
      max_events: 1000
      timeout_secs: 10
    buffer:
      type: disk
      max_size: 1 GiB
      when_full: block
